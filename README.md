# 장끼 매칭 동작 방식

## 1. 이미지 처리

### 1.1 이미지 비율 판단

- 이미지 가로 세로 비율이 1:8 이상인 경우:
  - 이미지 split 처리
    1. 이미지 이진화 처리
    2. 이진화된 이미지를 여러 장으로 나누기
    3. 나누는 기준:
       - 최대 높이 1500px
       - 이진화된 결과물에서 10px 이상 흰색 줄이 있으면 해당 줄을 기준으로 나눔
- 이미지 가로 세로 비율이 1:8 미만인 경우:
  - 이미지 그대로 사용

## 2. OCR 처리

1. 이미지 OCR API 호출
2. OCR confidence 출력
3. 이미지가 여러 장인 경우 OCR 결과 합치기:
   - confidence: 평균값 사용
   - words: 각 이미지의 boundingBox에 y좌표값을 수정하여 최종 좌표 생성

## 3. LLM 처리

1. OCR 결과물로 LLM API 호출

## 4. 결과 검증

### 4.1 검증 방법

1. 마크다운 출력 결과 처리:
   - 가장 앞줄에 ``` 있는 경우, 해당 부분을 제외하고 나머지 부분 검증
2. CSV 형식 유지 여부 검증
3. 영수증 헤더 검증
4. 영수증 총액 검증:
   - 영수증 총액만 추출하는 LLM 호출
   - 추출된 총액과 CSV의 총액 비교


# 비고
- 보니토에서 보낸 이미지 파일에 문제가 있음
- 디스코봉봉	런던트렌치코트	베이지 영수증에는 S인데 보내주신 주문 내역에는 L으로 표기 되어있음


11/17일 단상

현재 사이즈, 색상이 완전히 일치하는 경우만 매칭 처리하도록 알고리즘 구성했음.
둘중 하나만 일치하는 경우로 넣었더니 오류로 매칭하는 케이스들이 발생하여 보수적으로 변경
4o-mini는 미송건을 제대로 처리하지 못하는 경우가 발행하는 것을 발견 ㅠㅠ

4o의 경우도 마마미같이 기호 기반이 아닌 순서 기반인 경우에 미송건을 제대로 처리하지 못하는 케이스 발견